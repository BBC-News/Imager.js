(function(window,document){"use strict";var $,defaultWidths,getKeys,isArray;window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(callback){window.setTimeout(callback,1e3/60)};function applyEach(collection,callbackEach){var i=0,length=collection.length,new_collection=[];for(;i<length;i++){new_collection[i]=callbackEach(collection[i])}return new_collection}function returnDirectValue(d){return d}$=function(dollar){if(dollar){return dollar}return function(selector){return applyEach(document.querySelectorAll(selector),returnDirectValue)}}(window.$);defaultWidths=[96,130,165,200,235,270,304,340,375,410,445,485,520,555,590,625,660,695,736];getKeys=typeof Object.keys==="function"?Object.keys:function(object){var keys=[],key;for(key in object){keys.push(key)}return keys};isArray=function isArray(thing){return Object.prototype.toString.call(thing)==="[object Array]"};function Imager(elements,opts){var self=this;opts=opts||{};if(elements!==undefined){if(typeof elements==="string"){opts.selector=elements;elements=undefined}else if(!("length"in elements)){opts=elements;elements=undefined}}this.imagesOffScreen=[];this.viewportHeight=document.documentElement.clientHeight;this.selector=opts.selector||".delayed-image-load";this.className="."+(opts.className||"image-replace").replace(/^\.+/,".");this.gif=document.createElement("img");this.gif.src="data:image/gif;base64,R0lGODlhEAAJAIAAAP///wAAACH5BAEAAAAALAAAAAAQAAkAAAIKhI+py+0Po5yUFQA7";this.gif.className=this.className.replace(/^[#.]/,"");this.cache={};this.scrollDelay=opts.scrollDelay||250;this.onResize=opts.hasOwnProperty("onResize")?opts.onResize:true;this.lazyload=opts.hasOwnProperty("lazyload")?opts.lazyload:false;this.scrolled=false;this.devicePixelRatio=Imager.getPixelRatio();if(opts.availableWidths===undefined){opts.availableWidths=defaultWidths}if(isArray(opts.availableWidths)){this.availableWidths=opts.availableWidths;this.widthsMap=Imager.createWidthsMap(this.availableWidths)}else{this.availableWidths=getKeys(opts.availableWidths);this.widthsMap=opts.availableWidths}this.availableWidths=this.availableWidths.sort(function(a,b){return a-b});if(elements){this.divs=applyEach(elements,returnDirectValue);this.selector=null}else{this.divs=$(this.selector)}this.changeDivsToEmptyImages();window.requestAnimationFrame(function(){self.init()})}Imager.prototype.scrollCheck=function(){if(this.scrolled){if(!this.imagesOffScreen.length){window.clearInterval(this.interval)}this.divs=this.imagesOffScreen.slice(0);this.imagesOffScreen.length=0;this.changeDivsToEmptyImages();this.scrolled=false}};Imager.prototype.init=function(){this.initialized=true;this.checkImagesNeedReplacing();if(this.onResize){this.registerResizeEvent()}if(this.lazyload){this.registerScrollEvent()}};Imager.prototype.createGif=function(element){var gif=this.gif.cloneNode(false);gif.width=element.getAttribute("data-width");gif.setAttribute("data-src",element.getAttribute("data-src"));element.parentNode.replaceChild(gif,element)};Imager.prototype.changeDivsToEmptyImages=function(){var divs=this.divs,i=divs.length,element;while(i--){element=divs[i];if(this.lazyload){if(this.isThisElementOnScreen(element)){this.createGif(element)}else{this.imagesOffScreen.push(element)}}else{this.createGif(element)}}if(this.initialized){this.checkImagesNeedReplacing()}};Imager.prototype.isThisElementOnScreen=function(element){var offset="pageYOffset"in window?window.pageYOffset:document.documentElement.scrollTop;return element.offsetTop<this.viewportHeight+offset?true:false};Imager.prototype.checkImagesNeedReplacing=function(){var images=$(this.className),i=images.length,currentImage;if(!this.isResizing){this.isResizing=true;while(i--){currentImage=images[i];this.replaceImagesBasedOnScreenDimensions(currentImage)}this.isResizing=false}};Imager.prototype.replaceImagesBasedOnScreenDimensions=function(image){var computedWidth=typeof this.availableWidths==="function"?this.availableWidths(image):this.determineAppropriateResolution(image),src=this.changeImageSrcToUseNewImageDimensions(image.getAttribute("data-src"),computedWidth),parent=image.parentNode,replacedImage;if(this.cache[src]){replacedImage=this.cache[src].cloneNode(false);replacedImage.width=image.getAttribute("width")}else{replacedImage=image.cloneNode(false);replacedImage.src=src;this.cache[src]=replacedImage}parent.replaceChild(replacedImage,image)};Imager.prototype.determineAppropriateResolution=function(image){var imagewidth=image.clientWidth,i=this.availableWidths.length,selectedWidth=this.availableWidths[i-1];while(i--){if(imagewidth<=this.availableWidths[i]){selectedWidth=this.availableWidths[i]}}return selectedWidth};Imager.prototype.changeImageSrcToUseNewImageDimensions=function(src,selectedWidth){return src.replace(/{width}/g,Imager.transforms.width(selectedWidth,this.widthsMap)).replace(/{pixel_ratio}/g,Imager.transforms.pixelRatio(this.devicePixelRatio))};Imager.getPixelRatio=function getPixelRatio(){return window.devicePixelRatio||1};Imager.createWidthsMap=function createWidthsMap(widths){var map={},i=widths.length;while(i--){map[widths[i]]=null}return map};Imager.transforms={pixelRatio:function(value){return value===1?"":"-"+value+"x"},width:function transformWidth(width,map){return map[width]||width}};Imager.prototype.registerResizeEvent=function(){var self=this;window.addEventListener("resize",function(){self.checkImagesNeedReplacing()},false)};Imager.prototype.registerScrollEvent=function(){var self=this;this.scrolled=false;this.interval=window.setInterval(function(){self.scrollCheck()},self.scrollDelay);window.addEventListener("scroll",function(){self.scrolled=true},false)};if(typeof module==="object"&&typeof module.exports==="object"){module.exports=exports=Imager}else if(typeof define==="function"&&define.amd){define(function(){return Imager})}else if(typeof window==="object"){window.Imager=Imager}})(window,document);