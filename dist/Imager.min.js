(function(window,document){"use strict";var defaultWidths,getKeys,isArray,nextTick,addEvent,getNaturalWidth;nextTick=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(callback){window.setTimeout(callback,1e3/60)};function applyEach(collection,callbackEach){var i=0,length=collection.length,new_collection=[];for(;i<length;i++){new_collection[i]=callbackEach(collection[i],i)}return new_collection}function returnDirectValue(value){return value}getNaturalWidth=function(){if(document.createElement("img").hasOwnProperty("naturalWidth")){return function(image){return image.naturalWidth}}return function(source){var img=document.createElement("img");img.src=source.src;return img.width}}();addEvent=function(){if(document.addEventListener){return function addStandardEventListener(el,eventName,fn){return el.addEventListener(eventName,fn,false)}}else{return function addIEEventListener(el,eventName,fn){return el.attachEvent("on"+eventName,fn)}}}();defaultWidths=[96,130,165,200,235,270,304,340,375,410,445,485,520,555,590,625,660,695,736];getKeys=typeof Object.keys==="function"?Object.keys:function(object){var keys=[],key;for(key in object){keys.push(key)}return keys};isArray=function isArray(object){return Object.prototype.toString.call(object)==="[object Array]"};function Imager(elements,opts){var self=this,doc=document;opts=opts||{};if(elements!==undefined){if(typeof elements==="string"){opts.selector=elements;elements=undefined}else if(typeof elements.length==="undefined"){opts=elements;elements=undefined}}this.imagesOffScreen=[];this.viewportHeight=doc.documentElement.clientHeight;this.selector=opts.selector||".delayed-image-load";this.className=opts.className||"image-replace";this.gif=doc.createElement("img");this.gif.src="data:image/gif;base64,R0lGODlhEAAJAIAAAP///wAAACH5BAEAAAAALAAAAAAQAAkAAAIKhI+py+0Po5yUFQA7";this.gif.className=this.className;this.gif.alt="";this.scrollDelay=opts.scrollDelay||250;this.onResize=opts.hasOwnProperty("onResize")?opts.onResize:true;this.lazyload=opts.hasOwnProperty("lazyload")?opts.lazyload:false;this.scrolled=false;this.availablePixelRatios=opts.availablePixelRatios||[1,2];this.refreshPixelRatio();if(opts.availableWidths===undefined){opts.availableWidths=defaultWidths}if(isArray(opts.availableWidths)){this.availableWidths=opts.availableWidths;this.widthsMap=Imager.createWidthsMap(this.availableWidths)}else{this.availableWidths=getKeys(opts.availableWidths);this.widthsMap=opts.availableWidths}this.availableWidths=this.availableWidths.sort(function(a,b){return a-b});if(elements){this.divs=applyEach(elements,returnDirectValue);this.selector=null}else{this.divs=applyEach(doc.querySelectorAll(this.selector),returnDirectValue)}this.changeDivsToEmptyImages();nextTick(function(){self.init()})}Imager.prototype.scrollCheck=function(){if(this.scrolled){if(!this.imagesOffScreen.length){window.clearInterval(this.interval)}this.divs=this.imagesOffScreen.slice(0);this.imagesOffScreen.length=0;this.changeDivsToEmptyImages();this.scrolled=false}};Imager.prototype.init=function(){this.initialized=true;this.checkImagesNeedReplacing(this.divs);if(this.onResize){this.registerResizeEvent()}if(this.lazyload){this.registerScrollEvent()}};Imager.prototype.createGif=function(element){if(element.className.match(new RegExp("(^| )"+this.className+"( |$)"))){return element}var gif=this.gif.cloneNode(false);gif.width=element.getAttribute("data-width");gif.setAttribute("data-src",element.getAttribute("data-src"));gif.setAttribute("alt",element.getAttribute("data-alt")||this.gif.alt);element.parentNode.replaceChild(gif,element);return gif};Imager.prototype.changeDivsToEmptyImages=function(){var self=this;applyEach(this.divs,function(element,i){if(self.lazyload){if(self.isThisElementOnScreen(element)){self.divs[i]=self.createGif(element)}else{self.imagesOffScreen.push(element)}}else{self.divs[i]=self.createGif(element)}});if(this.initialized){this.checkImagesNeedReplacing(this.divs)}};Imager.prototype.isThisElementOnScreen=function(element){var offset=Imager.getPageOffset();var elementOffsetTop=0;if(element.offsetParent){do{elementOffsetTop+=element.offsetTop}while(element=element.offsetParent)}return elementOffsetTop<this.viewportHeight+offset?true:false};Imager.prototype.checkImagesNeedReplacing=function(images){var self=this;if(!this.isResizing){this.isResizing=true;this.refreshPixelRatio();applyEach(images,function(image){self.replaceImagesBasedOnScreenDimensions(image)});this.isResizing=false}};Imager.prototype.replaceImagesBasedOnScreenDimensions=function(image){var computedWidth,src,naturalWidth;naturalWidth=getNaturalWidth(image);computedWidth=typeof this.availableWidths==="function"?this.availableWidths(image):this.determineAppropriateResolution(image);if(image.src!==this.gif.src&&computedWidth<=naturalWidth){return}src=this.changeImageSrcToUseNewImageDimensions(image.getAttribute("data-src"),computedWidth);image.src=src};Imager.prototype.determineAppropriateResolution=function(image){return Imager.getClosestValue(image.clientWidth,this.availableWidths)};Imager.prototype.refreshPixelRatio=function refreshPixelRatio(){this.devicePixelRatio=Imager.getClosestValue(Imager.getPixelRatio(),this.availablePixelRatios)};Imager.prototype.changeImageSrcToUseNewImageDimensions=function(src,selectedWidth){return src.replace(/{width}/g,Imager.transforms.width(selectedWidth,this.widthsMap)).replace(/{pixel_ratio}/g,Imager.transforms.pixelRatio(this.devicePixelRatio))};Imager.getPixelRatio=function getPixelRatio(context){return(context||window)["devicePixelRatio"]||1};Imager.createWidthsMap=function createWidthsMap(widths){var map={},i=widths.length;while(i--){map[widths[i]]=null}return map};Imager.transforms={pixelRatio:function(value){return value===1?"":"-"+value+"x"},width:function(width,map){return map[width]||width}};Imager.getClosestValue=function getClosestValue(baseValue,candidates){var i=candidates.length,selectedWidth=candidates[i-1];while(i--){if(baseValue<=candidates[i]){selectedWidth=candidates[i]}}return selectedWidth};Imager.prototype.registerResizeEvent=function(){var self=this;addEvent(window,"resize",function(){self.checkImagesNeedReplacing(self.divs)})};Imager.prototype.registerScrollEvent=function(){var self=this;this.scrolled=false;this.interval=window.setInterval(function(){self.scrollCheck()},self.scrollDelay);addEvent(window,"scroll",function(){self.scrolled=true})};Imager.getPageOffsetGenerator=function getPageVerticalOffset(testCase){if(testCase){return function(){return window.pageYOffset}}else{return function(){return document.documentElement.scrollTop}}};Imager.getPageOffset=Imager.getPageOffsetGenerator(Object.prototype.hasOwnProperty.call(window,"pageYOffset"));Imager.applyEach=applyEach;if(typeof module==="object"&&typeof module.exports==="object"){module.exports=exports=Imager}else if(typeof define==="function"&&define.amd){define(function(){return Imager})}else if(typeof window==="object"){window.Imager=Imager}})(window,document);